
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Index";
}

<h2>Site</h2>
@section Scripts{
    <script>
        $(function () {

            var currentVisitor = window.localStorage.getItem("visitorId");

            var chatsuppHub = null;

            var createChatBox = function (agentName) {
                return $.ajax({
                    url: "/Chatsupp/Visitor/ChatBoxVisitor",
                    type: "GET",
                    cache: false,
                    contentType: "application/json",
                    data: { title: agentName },
                    success: function (resp) {
                        $(".chatboxContainer").append(resp);
                        if (window.localStorage.getItem("visitor_setName") != null) {
                            $("#visitorName").remove();
                            $("input[name='message']").attr("disabled", false);
                        }
                        else 
                            $("#btnNameOk").click(setVisitorName);
                        $(".chat form").submit(sendMessageToAgent);

                    }
                })
            }

            var sendMessage = function () {
                chatsuppHub.server.registerVisitor(name);
            }

            var setVisitorName = function () {
                var name = $("input[name='visitorName']").val();
                chatsuppHub.server.setVisitorName(name);
            }

            var disconnect = function () {
                chatsuppHub.server.visitorDisconnect(name).done(function () {
                    $.connection.hub.stop().done(function () {
                        console.log("disconnected");
                    });
                });
                
            }

            var sendMessageToAgent = function (e) {

                e.preventDefault();

                chatsuppHub.server.sendToAgent($(this).find("input[name='message']").val());
            }

            var init = function () {

                // Reference the auto-generated proxy for the hub.
                chatsuppHub = $.connection.chatsuppHub;

                // Start the connection.
                $.connection.hub.start().done(function () {
                    console.log("successful connection");
                    chatsuppHub.server.registerVisitor(currentVisitor);
                    createChatBox()

                });
                //ChtuHub callbacks
                chatsuppHub.client.receiveMessage = function (agentName, message) {
                    
                    createChatBox().done(function () {
                        alert(agentName + "says: " + message);
                    });
                };

                chatsuppHub.client.registerResult = function (result) {

                    if (currentVisitor == null)
                        window.localStorage.setItem("visitorId", result);
                    
                    $("input[name='message']").attr("disabled", false);
                };

                chatsuppHub.client.setNameResult = function (result) {

                    window.localStorage.setItem("visitor_setName", result);
                
                };

            }

            init();

        });

    </script>
}