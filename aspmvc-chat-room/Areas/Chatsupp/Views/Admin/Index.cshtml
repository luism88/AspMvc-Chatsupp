@model IList<AspMvcChatsupp.DataAccess.Domain.ConnectionInfo>
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

    <h2>BAdmin</h2>
    <input type="hidden" name="agentName" value="@AspMvcChatsupp.MVC.Helpers.SessionHelper.AgentName" />
    <input type="hidden" name="agentId" value="@AspMvcChatsupp.MVC.Helpers.SessionHelper.AgentId" />
    <table class="table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Address</th>
                <th>Machine</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr data-name="@item.Visitor.Name" data-conninfoid="@item.ConnectionInfoId">
                    <td>@item.Visitor.Name</td>
                    <td>@item.Visitor.Location</td>
                    <td>@item.Visitor.OperatingSystem</td>
                </tr>
                
            }
        </tbody>
    </table>
@section Scripts{
    <script type="text/javascript">
        $(function () {
            var connInfoId = null;
            var chatsuppHub = null;
            var createChatBox = function (visitorName) {
                console.log(visitorName);
                $.ajax({
                    url: "/Chatsupp/Admin/ChatBoxAgent",
                    type: "GET",
                    contentType: "application/json",
                    data: {title: visitorName },
                    success: function (resp) {
                        $("body").append(resp);
                        //$("#btnNameOk").click(registerVisitor);
                        $("#formChat").submit(sendMessageToVisitor);
                    }
                })
            }

            var clientCallBacks = function (chat) {

                // Create a function that the hub can call back to display messages.
                chat.client.receiveClientMsg = function (agentData, message) {
                    createChatBox()
                };

                chat.client.registerResult = function (userData) {
                    //aca agregar un coockie con el datos del usuario
                    console.log(userData);
                };

            }

            var sendMessageToVisitor = function (e) {
                
                e.preventDefault();
                
                chatsuppHub.server.sendToUser($("input[name='agentId']").val(), connInfoId, $(this).find("input[name='message']").val());
            }

            var init = function () {
                
                chatsuppHub = $.connection.chatsuppHub;

                // Start the connection.
                $.connection.hub.start().done(function () {
                    console.log("successful connection");
                });

                //ChtuHub callbacks
                chatsuppHub.client.receiveVisitorMessage = function (agentData, message) {
                    createChatBox()
                };

                $("table tbody tr").click(function () {
                    connInfoId = $(this).data("conninfoid");
                    createChatBox($(this).data("name"));
                })

            }

            init();
        });

    </script>  
}
